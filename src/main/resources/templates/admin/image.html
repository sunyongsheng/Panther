<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>图片管理 —— Panther</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script src="https://unpkg.com/element-ui@2.15.6/lib/index.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.15.6/lib/theme-chalk/index.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/common.css}">
    <!-- axios必须引入且在request.js之前 -->
    <script type="text/javascript" th:src="@{/js/axios.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/request.js}"></script>
    <script type="text/javascript" th:src="@{/js/common/common.js}"></script>
    <script type="text/javascript" th:src="@{/js/image/image.js}"></script>
</head>
<body>
<div id="app">
    <el-container>
        <div th:replace="admin/sidebar::admin-sidebar(index='image-manager')"></div>

        <el-container direction="vertical">
            <div th:replace="admin/sidebar::admin-header"></div>

            <el-main>
                <el-button type="primary" icon="el-icon-upload" size="medium" @click="onClickUpload">上传图片</el-button>
                <div class="space-column-20"></div>
                <el-table
                        :data="imageData"
                        v-loading="loadingImageData"
                        style="width: 100%;"
                        @selection-change="onSelectionChange">
                    <el-table-column type="selection" width="55"></el-table-column>
                    <el-table-column label="预览" align="center" width="100">
                        <template slot-scope="scope">
                            <el-image :src="scope.row.url" :preview-src-list="previewImages" fit="contain"></el-image>
                        </template>
                    </el-table-column>
                    <el-table-column prop="name" label="名称" align="center">
                        <template slot-scope="scope">
                            <el-tooltip class="item" effect="dark" :content="'点击复制：' + scope.row.name" placement="top">
                                <el-link @click="onClickImageName(scope.row)">{{ scope.row.nameEllipsis }}</el-link>
                            </el-tooltip>
                        </template>
                    </el-table-column>
                    <el-table-column prop="url" label="图片URL" align="center" min-width="140">
                        <template slot-scope="scope">
                            <el-tooltip class="item" effect="dark" :content="'点击复制：' + scope.row.url" placement="top">
                                <el-link @click="onClickCopyImageUrl(scope.row)">{{ scope.row.urlEllipsis }}</el-link>
                            </el-tooltip>
                        </template>
                    </el-table-column>
                    <el-table-column prop="ownerApp" label="所属App" align="center"></el-table-column>
                    <el-table-column label="状态" align="center">
                        <template slot-scope="scope">
                            <el-tag v-if="scope.row.deleted" type="danger">回收站</el-tag>
                            <el-tag v-else type="success">正常</el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column prop="uploadTimeFormatted" label="上传时间" align="center"></el-table-column>
                    <el-table-column prop="sizeFormatted" label="图片大小" align="center"></el-table-column>
                    <el-table-column label="操作" align="center">
                        <template slot-scope="scope">
                            <el-button :type="scope.row.deleted ? 'warning' : 'danger'" size="mini" @click="onClickDeleteImage(scope.row)">
                                {{scope.row.deleted ? '恢复' : '删除'}}
                            </el-button>
                        </template>
                    </el-table-column>
                </el-table>
                <div class="space-column-20"></div>
                <el-pagination v-if="totalPage > 1"
                               background
                               layout="prev, pager, next"
                               :page-count="totalPage"
                               :current-page="currPage"
                               @current-change="onChangePage">
                </el-pagination>
            </el-main>
        </el-container>
    </el-container>
</div>

</body>
<script>
    new Vue({
        el: '#app',
        data() {
            return {
                imageData: [],
                previewImages: [],
                loadingImageData: false,
                currPage: 1,
                totalPage: 1,
                pageSize: 10,

                multipleSelection: [],
            }
        },
        methods: {
            fetchImageData() {
                this.loadingAppData = true;
                let fetchedData = []
                getAllImages(this.currPage - 1, this.pageSize).then(response => {
                    this.totalPage = response.data.totalPages;
                    response.data.content.forEach(image => {
                        image.nameEllipsis = ellipsisText(image.name, 20);
                        image.urlEllipsis = ellipsisText(image.url, 40);
                        image.uploadTimeFormatted = formatDate(new Date(image.uploadTime), "yyyy-MM-dd hh:mm:ss");
                        image.sizeFormatted = getSizeFromByte(image.size);
                        image.deleted = image.status === 'DELETED';
                        fetchedData.push(image);
                    });
                    this.imageData = fetchedData;
                    this.imageData.forEach(image => {
                        this.previewImages.push(image.url);
                    })
                }).catch(e => {
                    this.$message.error(e.msg)
                }).finally(_ => {
                    this.loadingAppData = false;
                })
            },
            onClickUpload() {

            },
            onClickImageName(image) {
                try {
                    navigator.clipboard.writeText(image.name);
                    this.$notify({
                        title: '复制成功',
                        duration: 2000,
                        type: 'success'
                    });
                } catch (err) {
                    this.$notify.error({
                        title: '复制失败，请手动复制',
                        message: image.name,
                        duration: 0
                    });
                }
            },
            onClickCopyImageUrl(image) {
                try {
                    navigator.clipboard.writeText(image.url);
                    this.$notify({
                        title: '复制成功',
                        duration: 2000,
                        type: 'success'
                    });
                } catch (err) {
                    this.$notify.error({
                        title: '复制失败，请手动复制',
                        message: image.url,
                        duration: 0
                    });
                }
            },
            onClickDeleteImage(image) {
                if (image.deleted) {
                    this.$confirm('确认恢复图片吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        undeleteImage(image.id).then(response => {
                            this.$message.success(response.msg);
                            this.fetchImageData();
                        }).catch(e => {
                            this.$message.error(e.msg);
                        });
                    });
                } else {
                    this.$confirm('图片删除后将暂存在回收站中，30天后自动删除，是否继续？', '警告', {
                        confirmButtonClass: 'delete-action-confirm',
                        confirmButtonText: '删除',
                        cancelButtonText: '取消',
                        type: 'error'
                    }).then(() => {
                        deleteImage(image.id).then(response => {
                            this.$message.success(response.msg);
                            this.fetchImageData();
                        }).catch(e => {
                            this.$message.error(e.msg);
                        });
                    });
                }
            },
            onSelectionChange(val) {
                this.multipleSelection = val;
            },
            onChangePage(page) {
                this.currPage = page;
                this.fetchImageData();
            },
            onSelectSideMenu(index, _) {
                window.location.href = "/admin/" + index;
            }
        },
        created() {
            this.fetchImageData();
        }
    })
</script>
<style>
    .aside-title {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .user-info {
        display: flex;
        flex-direction: row;
        align-items: center;
    }
    body {
        font-family: Arial, sans-serif;
    }
    .el-header {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        margin: 10px 30px
    }
    .el-main {
        background-color: #F5F5FA;
    }
</style>
</html>